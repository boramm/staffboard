<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµì§ì› í˜„í™©íŒ - ì¶œë ¥ìš©</title>
  <link rel="stylesheet" href="css/print-mode.css">
</head>
<body>
  <!-- ===== í—¤ë” ===== -->
  <header class="print-header">
    <div class="header-left">
      <h1 class="print-title">ğŸ« ìƒ˜í”ŒëŒ€í•™êµ êµì§ì› í˜„í™©íŒ</h1>
      <span class="print-semester">ë°ëª¨ ë²„ì „</span>
    </div>
    <div class="header-right">
      <div class="total-count">ì´ì› <strong id="totalCount">0</strong>ëª…</div>
      <div class="legend">
        <span class="legend-item regular">â–  ì •ê·œì§</span>
        <span class="legend-item contract">â–  ê³„ì•½ì§</span>
        <span class="legend-item functional">â–  ê¸°ëŠ¥ì§</span>
        <span class="legend-item leader">â­ íŒ€ì¥ê¸‰</span>
      </div>
    </div>
  </header>

  <!-- ===== ë©”ì¸: 20x13 ê·¸ë¦¬ë“œ ===== -->
  <main class="print-container">
    <!-- ì¢Œì¸¡ ë¸”ë¡ (A1~T13) -->
    <div class="block left-block" id="leftBlock"></div>
    
    <!-- ìš°ì¸¡ ë¸”ë¡ (U1~AN13) -->
    <div class="block right-block" id="rightBlock"></div>
  </main>

  <!-- ===== ì¸ì‡„ ë²„íŠ¼ (í™”ë©´ìš©) ===== -->
  <div class="print-controls no-print">
    <button onclick="window.print()" class="btn-print">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
    <button onclick="window.close()" class="btn-close">âœ• ë‹«ê¸°</button>
  </div>

  <script type="module">
    import { loadFromLocalStorage, getBoardData } from './js/data-manager.js';
    import { indexToCoordinate, getBlockFromCoordinate } from './js/grid-system.js';
    import { getAllPhotos } from './js/photo-manager.js';

    const COLS = 20;
    const ROWS = 13;
    let photoCache = {};

    // ì§ì¢… ë¶„ë¥˜ (ì •ê·œì§/ê³„ì•½ì§/ê¸°ëŠ¥ì§)
    function getEmpType(emp) {
      // empType í•„ë“œê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
      if (emp.empType) return emp.empType;
      
      // ì—†ìœ¼ë©´ positionì—ì„œ ì¶”ë¡ 
      const pos = emp.position || '';
      if (pos.includes('ê³„ì•½') || pos.includes('ì´‰íƒ') || pos.includes('ë¬´ê¸°')) return 'contract';
      if (pos === 'ê¸°ëŠ¥ì§') return 'functional';
      return 'regular';
    }

    // íŒ€ì¥ê¸‰ ì—¬ë¶€ (íŒ€ì¥, ì²˜ì¥ë§Œ)
    function isLeader(position) {
      const pos = position || '';
      return pos.includes('íŒ€ì¥') || pos.includes('ì²˜ì¥');
    }

    // ê·¸ë¦¬ë“œ ì…€ ìƒì„±
    function createGridCells(blockEl, startCol) {
      for (let row = 1; row <= ROWS; row++) {
        for (let col = 0; col < COLS; col++) {
          const cell = document.createElement('div');
          cell.className = 'grid-cell';
          const globalCol = startCol + col;
          const coord = indexToCoordinate((row - 1) * 40 + globalCol);
          cell.dataset.coord = coord;
          blockEl.appendChild(cell);
        }
      }
    }

    // ë¶€ì„œ ì¹´ë“œ ìƒì„±
    function createDeptCard(dept) {
      const card = document.createElement('div');
      card.className = 'dept-card';
      if (dept.isParentOrg) card.classList.add('parent-org');
      
      const deptName = document.createElement('div');
      deptName.className = 'dept-name';
      deptName.textContent = dept.dept;
      card.appendChild(deptName);
      
      if (dept.subDept) {
        const subDept = document.createElement('div');
        subDept.className = 'sub';
        subDept.textContent = dept.subDept;
        card.appendChild(subDept);
      }
      
      return card;
    }

    // ì§ì› ì¹´ë“œ ìƒì„±
    function createEmpCard(emp) {
      const card = document.createElement('div');
      card.className = 'emp-card';
      
      // ì§ì¢… í´ë˜ìŠ¤
      card.classList.add(getEmpType(emp));
      if (isLeader(emp.position)) card.classList.add('leader');
      
      // ì‚¬ì§„
      const photoDiv = document.createElement('div');
      photoDiv.className = 'emp-photo';
      
      let photoSrc = null;
      if (emp.photo?.startsWith('indexeddb://')) {
        photoSrc = photoCache[emp.id] || null;
      } else if (emp.photo) {
        photoSrc = emp.photo;
      }
      
      if (photoSrc) {
        const img = document.createElement('img');
        img.src = photoSrc;
        img.alt = emp.name;
        img.style.objectPosition = `center ${emp.photoPosY || 30}%`;
        photoDiv.appendChild(img);
      } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'photo-placeholder';
        placeholder.textContent = 'ğŸ“·';
        photoDiv.appendChild(placeholder);
      }
      card.appendChild(photoDiv);
      
      // ì •ë³´
      const infoDiv = document.createElement('div');
      infoDiv.className = 'emp-info';
      
      const nameDiv = document.createElement('div');
      nameDiv.className = 'emp-name';
      nameDiv.textContent = isLeader(emp.position) ? `${emp.name}â­` : emp.name;
      infoDiv.appendChild(nameDiv);
      
      if (emp.position) {
        const posDiv = document.createElement('div');
        posDiv.className = 'emp-position';
        posDiv.textContent = emp.position;
        infoDiv.appendChild(posDiv);
      }
      
      card.appendChild(infoDiv);
      return card;
    }

    // ì¢Œí‘œë¡œ ì…€ ì°¾ê¸°
    function getCellByCoord(coord) {
      const block = getBlockFromCoordinate(coord);
      const blockEl = document.getElementById(block === 'left' ? 'leftBlock' : 'rightBlock');
      return blockEl?.querySelector(`.grid-cell[data-coord="${coord}"]`);
    }

    // ë Œë”ë§
    async function render() {
      const boardData = await loadFromLocalStorage();
      if (!boardData) {
        document.querySelector('.print-container').innerHTML = '<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      // ì‚¬ì§„ ë¡œë“œ
      try {
        photoCache = await getAllPhotos();
      } catch (e) {
        console.warn('ì‚¬ì§„ ë¡œë“œ ì‹¤íŒ¨:', e);
      }

      // ê·¸ë¦¬ë“œ ìƒì„±
      const leftBlock = document.getElementById('leftBlock');
      const rightBlock = document.getElementById('rightBlock');
      createGridCells(leftBlock, 0);    // A~T (0~19)
      createGridCells(rightBlock, 20);  // U~AN (20~39)

      // ì´ì› í‘œì‹œ
      document.getElementById('totalCount').textContent = boardData.employees?.length || 0;

      // ë¶€ì„œ ì¹´ë“œ ë Œë”ë§
      boardData.departments?.forEach(dept => {
        const cell = getCellByCoord(dept.location.coordinate);
        if (cell) {
          cell.appendChild(createDeptCard(dept));
        }
      });

      // ì§ì› ì¹´ë“œ ë Œë”ë§
      boardData.employees?.forEach(emp => {
        const cell = getCellByCoord(emp.location.coordinate);
        if (cell) {
          cell.appendChild(createEmpCard(emp));
        }
      });
    }

    // ì´ˆê¸°í™”
    render();
  </script>
</body>
</html>
