<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµì§ì› í˜„í™©íŒ V2</title>
  <link rel="stylesheet" href="css/work-mode.css">
  <script>
    // âš ï¸ ì¼íšŒì„± ë°ì´í„° ì´ˆê¸°í™” - empType í•„ë“œ ì¶”ê°€ (ì´ ì½”ë“œëŠ” ë‚˜ì¤‘ì— ì‚­ì œí•´ë„ ë¨)
    if (!localStorage.getItem('v2_emptype_fix_v4')) {
      localStorage.removeItem('staffboard_v2');
      localStorage.setItem('v2_emptype_fix_v4', 'done');
      console.log('[ì´ˆê¸°í™”] localStorage ì‚­ì œ ì™„ë£Œ');
    }
  </script>
</head>
<body>
  <!-- ===== ìƒë‹¨: í—¤ë” ì˜ì—­ ===== -->
  <header class="header">
    <h1 class="header-title">ğŸ« ì‚¼ìœ¡ëŒ€ êµì§ì› í˜„í™©íŒ 2025-2í•™ê¸°</h1>
    <div class="header-buttons">
      <button class="btn-photo" id="bulkPhotoBtn">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</button>
      <button class="btn-scenario" id="toggleScenarioBtn">ğŸ“ ì‹œë‚˜ë¦¬ì˜¤</button>
      <button class="btn-print" onclick="window.open('print.html', '_blank')">ğŸ“„ ì¶œë ¥ ë³´ê¸°</button>
    </div>
  </header>

  <!-- ===== ì‹œë‚˜ë¦¬ì˜¤ íŒ¨ë„ (ì‚¬ì´ë“œ) ===== -->
  <aside class="scenario-panel" id="scenarioPanel">
    <div class="scenario-header">
      <h3>ğŸ“ ì‹œë‚˜ë¦¬ì˜¤ ê´€ë¦¬</h3>
      <button class="btn-close-panel" id="closeScenarioBtn">âœ•</button>
    </div>
    <div class="scenario-save-area">
      <input type="text" id="scenarioNameInput" placeholder="ì‹œë‚˜ë¦¬ì˜¤ ì´ë¦„" class="scenario-input">
      <button class="btn-save-scenario" id="saveScenarioBtn">ì €ì¥</button>
    </div>
    <div class="scenario-list-area">
      <div class="scenario-list-title">ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤</div>
      <ul class="scenario-list" id="scenarioList">
        <!-- JavaScriptë¡œ ëª©ë¡ ìƒì„± -->
      </ul>
      <div class="scenario-empty" id="scenarioEmpty">ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>
    </div>
  </aside>

  <!-- ===== ì¤‘ì•™: ë³´ë“œ ì˜ì—­ ===== -->
  <main class="board-container">
    <!-- ì¢Œì¸¡ ë¸”ë¡ (20ì—´ x 13í–‰) -->
    <div class="block-wrapper">
      <div class="block-label">ì¢Œì¸¡ ë¸”ë¡ (A~T)</div>
      <div class="col-headers" id="leftColHeaders">
        <div class="corner-cell"></div>
        <!-- JavaScriptë¡œ A~T ì—´ í—¤ë” ìƒì„± -->
      </div>
      <div class="block-with-rows">
        <div class="row-headers" id="leftRowHeaders">
          <!-- JavaScriptë¡œ 1~13 í–‰ í—¤ë” ìƒì„± -->
        </div>
        <div class="block" id="leftBlock">
          <!-- JavaScriptë¡œ 260ê°œ ì…€ ìƒì„± -->
        </div>
      </div>
    </div>
    
    <!-- ìš°ì¸¡ ë¸”ë¡ (20ì—´ x 13í–‰) -->
    <div class="block-wrapper">
      <div class="block-label">ìš°ì¸¡ ë¸”ë¡ (U~AN)</div>
      <div class="col-headers" id="rightColHeaders">
        <div class="corner-cell"></div>
        <!-- JavaScriptë¡œ U~AN ì—´ í—¤ë” ìƒì„± -->
      </div>
      <div class="block-with-rows">
        <div class="row-headers" id="rightRowHeaders">
          <!-- JavaScriptë¡œ 1~13 í–‰ í—¤ë” ìƒì„± -->
        </div>
        <div class="block" id="rightBlock">
          <!-- JavaScriptë¡œ 260ê°œ ì…€ ìƒì„± -->
        </div>
      </div>
    </div>
  </main>

  <!-- ===== í•˜ë‹¨: ì±„íŒ… ì…ë ¥ ì˜ì—­ ===== -->
  <footer class="chat-container">
    <div class="chat-input-area">
      <input 
        type="text" 
        id="commandInput" 
        class="chat-input" 
        placeholder="ì˜ˆ) í™ê¸¸ë™ì„ í•™ìƒì²˜ë¡œ ì´ë™"
        autocomplete="off"
      >
      <button class="btn-execute" id="executeBtn">ì‹¤í–‰</button>
    </div>
    
    <!-- ìµœê·¼ ëª…ë ¹ íˆìŠ¤í† ë¦¬ -->
    <div class="history-area" id="historyArea">
      <div class="history-title">ìµœê·¼ ëª…ë ¹:</div>
      <ul class="history-list" id="historyList">
        <!-- JavaScriptë¡œ ìµœê·¼ 3ê°œ ëª…ë ¹ í‘œì‹œ -->
      </ul>
    </div>
  </footer>

  <script type="module">
    // ===== ëª¨ë“ˆ import =====
    import { BOARD_CONFIG, DEPT_ORDER, genId, getCurrentDateTime } from './js/config.js';
    import { 
      indexToCoordinate, 
      coordinateToIndex, 
      isValidCoordinate,
      parseCoordinate 
    } from './js/grid-system.js';
    import {
      loadData,
      loadFromLocalStorage,
      getBoardData,
      findEmployeeById,
      findEmployeeByName,
      findByCoordinate,
      moveEmployee,
      swapEmployees
    } from './js/data-manager.js';
    import { renderBoard, highlightCard } from './js/renderer.js';
    import { parseCommand, getResultMessage } from './js/command-parser.js';
    import { executeCommand as runCommand, initApp } from './js/app.js';
    import {
      getScenarios,
      saveScenario,
      loadScenarioByName,
      deleteScenarioByName
    } from './js/scenario-manager.js';
    import { initDragAndDrop, enableCardDrag } from './js/drag-handler.js';
    import { 
      initPhotoManager, 
      openPhotoEditor, 
      openBulkUploadModal 
    } from './js/photo-manager.js';
    
    // ëª¨ë“ˆ import ë¡œê·¸
    console.log('[index.html] ëª¨ë“  ëª¨ë“ˆ import ì„±ê³µ');
    
    // ===== ì¢Œí‘œ ìƒì„± í•¨ìˆ˜ (ì—‘ì…€ ìŠ¤íƒ€ì¼, grid-system.js ì‚¬ìš©) =====
    // ì—´ ë²ˆí˜¸ â†’ ì—´ ë¬¸ì (0=A, 25=Z, 26=AA, 39=AN)
    function colToLetter(col) {
      if (col < 26) {
        return String.fromCharCode(65 + col);
      } else {
        return 'A' + String.fromCharCode(65 + col - 26);
      }
    }
    
    // ë¸”ë¡ë³„ ì¢Œí‘œ ìƒì„±
    function getBlockCoordinate(blockName, localIndex) {
      const localCol = localIndex % 20;
      const row = Math.floor(localIndex / 20);
      
      // ì¢Œì¸¡: A~T (0~19), ìš°ì¸¡: U~AN (20~39)
      const globalCol = blockName === 'left' ? localCol : localCol + 20;
      
      return colToLetter(globalCol) + (row + 1);
    }

    // ===== ì—´/í–‰ í—¤ë” ìƒì„± (ì—‘ì…€ ìŠ¤íƒ€ì¼) =====
    function createColumnHeaders(headerId, startCol) {
      const container = document.getElementById(headerId);
      for (let i = 0; i < 20; i++) {
        const header = document.createElement('div');
        header.className = 'col-header';
        header.textContent = colToLetter(startCol + i);
        container.appendChild(header);
      }
    }
    
    function createRowHeaders(headerId) {
      const container = document.getElementById(headerId);
      for (let i = 1; i <= 13; i++) {
        const header = document.createElement('div');
        header.className = 'row-header';
        header.textContent = i;
        container.appendChild(header);
      }
    }
    
    // ===== ê·¸ë¦¬ë“œ ì…€ ìƒì„± =====
    function createGridCells(blockId) {
      const block = document.getElementById(blockId);
      const blockName = blockId === 'leftBlock' ? 'left' : 'right';
      
      for (let i = 0; i < 260; i++) {  // 20 x 13 = 260
        const coord = getBlockCoordinate(blockName, i);
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.dataset.coord = coord;
        cell.dataset.block = blockName;
        cell.dataset.index = i;
        
        // ì…€ ë‚´ë¶€ ì¢Œí‘œ ë¼ë²¨ì€ ì´ì œ ìˆ¨ê¹€ (ìƒë‹¨/ì¢Œì¸¡ í—¤ë”ê°€ ìˆìœ¼ë¯€ë¡œ)
        // const coordLabel = document.createElement('span');
        // coordLabel.className = 'coord-label';
        // coordLabel.textContent = coord;
        // cell.appendChild(coordLabel);
        
        block.appendChild(cell);
      }
    }

    // ===== ëª…ë ¹ ì‹¤í–‰ =====
    async function executeCommand() {
      const input = document.getElementById('commandInput');
      const command = input.value.trim();
      
      if (!command) return;
      
      // ëª…ë ¹ì–´ íŒŒì‹±
      const cmdObj = parseCommand(command);
      console.log('[íŒŒì‹± ê²°ê³¼]', cmdObj);
      
      // ëª…ë ¹ ì‹¤í–‰ (app.jsì˜ runCommand)
      const result = await runCommand(cmdObj);
      console.log('[ì‹¤í–‰ ê²°ê³¼]', result);
      
      // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€ (ê²°ê³¼ ë©”ì‹œì§€ í¬í•¨)
      addToHistory(result.message || command, result.success);
      
      // ì…ë ¥ì°½ ë¹„ìš°ê¸°
      input.value = '';
    }

    // ===== íˆìŠ¤í† ë¦¬ ì¶”ê°€ =====
    const commandHistory = [];
    
    function addToHistory(command, success) {
      commandHistory.unshift({ command, success, time: new Date() });
      
      // ìµœëŒ€ 3ê°œë§Œ ìœ ì§€
      if (commandHistory.length > 3) {
        commandHistory.pop();
      }
      
      renderHistory();
    }

    function renderHistory() {
      const list = document.getElementById('historyList');
      list.innerHTML = '';
      
      commandHistory.forEach(item => {
        const li = document.createElement('li');
        li.className = item.success ? 'history-success' : 'history-fail';
        li.textContent = item.command;
        list.appendChild(li);
      });
    }

    // ===== ì‹œë‚˜ë¦¬ì˜¤ íŒ¨ë„ =====
    function toggleScenarioPanel() {
      const panel = document.getElementById('scenarioPanel');
      panel.classList.toggle('open');
      if (panel.classList.contains('open')) {
        renderScenarioList();
      }
    }

    function renderScenarioList() {
      const list = document.getElementById('scenarioList');
      const empty = document.getElementById('scenarioEmpty');
      const scenarios = getScenarios();
      
      list.innerHTML = '';
      
      if (scenarios.length === 0) {
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      
      scenarios.forEach(scenario => {
        const li = document.createElement('li');
        li.className = 'scenario-item';
        li.innerHTML = `
          <div class="scenario-item-name">${scenario.name}</div>
          <div class="scenario-item-date">${scenario.createdAt}</div>
          <div class="scenario-item-actions">
            <button class="btn-load-scenario" data-name="${scenario.name}">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn-delete-scenario" data-name="${scenario.name}">ì‚­ì œ</button>
          </div>
        `;
        list.appendChild(li);
      });
      
      // ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
      list.querySelectorAll('.btn-load-scenario').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const name = btn.dataset.name;
          const success = loadScenarioByName(name);
          if (success) {
            renderBoard();
            addToHistory(`âœ… ì‹œë‚˜ë¦¬ì˜¤ "${name}" ë¶ˆëŸ¬ì˜´`, true);
          }
        });
      });
      
      // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
      list.querySelectorAll('.btn-delete-scenario').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const name = btn.dataset.name;
          if (confirm(`"${name}" ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) {
            deleteScenarioByName(name);
            renderScenarioList();
            addToHistory(`ğŸ—‘ï¸ ì‹œë‚˜ë¦¬ì˜¤ "${name}" ì‚­ì œë¨`, true);
          }
        });
      });
    }

    function handleSaveScenario() {
      const input = document.getElementById('scenarioNameInput');
      let name = input.value.trim();
      
      if (!name) {
        const now = new Date();
        name = `${now.getMonth() + 1}ì›”${now.getDate()}ì¼_${now.getHours()}ì‹œ${now.getMinutes()}ë¶„`;
      }
      
      const scenario = saveScenario(name);
      if (scenario) {
        input.value = '';
        renderScenarioList();
        addToHistory(`ğŸ“ ì‹œë‚˜ë¦¬ì˜¤ "${name}" ì €ì¥ë¨`, true);
      }
    }

    // ===== ì´ˆê¸°í™” =====
    document.addEventListener('DOMContentLoaded', async () => {
      // ì—´/í–‰ í—¤ë” ìƒì„± (ì—‘ì…€ ìŠ¤íƒ€ì¼)
      createColumnHeaders('leftColHeaders', 0);    // A~T (0~19)
      createColumnHeaders('rightColHeaders', 20);  // U~AN (20~39)
      createRowHeaders('leftRowHeaders');
      createRowHeaders('rightRowHeaders');
      
      // ì¢Œ/ìš° ë¸”ë¡ì— ê·¸ë¦¬ë“œ ì…€ ìƒì„±
      createGridCells('leftBlock');
      createGridCells('rightBlock');
      
      // ì‹¤í–‰ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById('executeBtn').addEventListener('click', executeCommand);
      
      // Enter í‚¤ë¡œ ì‹¤í–‰
      document.getElementById('commandInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          executeCommand();
        }
      });
      
      // ì‹œë‚˜ë¦¬ì˜¤ íŒ¨ë„ ì´ë²¤íŠ¸
      document.getElementById('toggleScenarioBtn').addEventListener('click', toggleScenarioPanel);
      document.getElementById('closeScenarioBtn').addEventListener('click', toggleScenarioPanel);
      document.getElementById('saveScenarioBtn').addEventListener('click', handleSaveScenario);
      document.getElementById('scenarioNameInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleSaveScenario();
        }
      });
      
      // ì•± ì´ˆê¸°í™” (ë°ì´í„° ë¡œë“œ + ë Œë”ë§)
      await initApp();
      
      // ì‚¬ì§„ ê´€ë¦¬ì ì´ˆê¸°í™”
      await initPhotoManager();
      
      // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ˆê¸°í™”
      initDragAndDrop();
      enableCardDrag();
      
      // ì‚¬ì§„ ì—…ë¡œë“œ ë²„íŠ¼
      document.getElementById('bulkPhotoBtn').addEventListener('click', openBulkUploadModal);
      
      // ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ (ì§ì› ì¹´ë“œ â†’ ì‚¬ì§„ í¸ì§‘, ë¹ˆ ì…€ â†’ ì§ì› ì¶”ê°€)
      document.addEventListener('dblclick', (e) => {
        // 1. ì§ì› ì¹´ë“œ ë”ë¸”í´ë¦­ â†’ ì‚¬ì§„ í¸ì§‘
        const empCard = e.target.closest('.emp-card');
        if (empCard) {
          const empId = empCard.dataset.id;
          if (empId) {
            openPhotoEditor(empId);
          }
          return;
        }
        
        // 2. ë¶€ì„œ ì¹´ë“œëŠ” renderer.jsì—ì„œ ì²˜ë¦¬ (ë¬´ì‹œ)
        if (e.target.closest('.dept-card')) {
          return;
        }
        
        // 3. ë¹ˆ ì…€ ë”ë¸”í´ë¦­ â†’ ì¶”ê°€ ì„ íƒ íŒì—… (ì§ì›/ë¶€ì„œ)
        const cell = e.target.closest('.grid-cell');
        if (cell && !cell.querySelector('.emp-card, .dept-card')) {
          const coord = cell.dataset.coord;
          openAddSelectionModal(coord);
        }
      });
      
      // ì˜¤ë¥¸ìª½ í´ë¦­ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´
      document.addEventListener('contextmenu', (e) => {
        const card = e.target.closest('.emp-card, .dept-card');
        if (card) {
          e.preventDefault();
          showContextMenu(e.pageX, e.pageY, card);
        }
      });
      
      // í´ë¦­ ì‹œ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ë‹«ê¸°
      document.addEventListener('click', () => {
        const menu = document.querySelector('.context-menu');
        if (menu) menu.remove();
      });
      
      // ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡ ì´ˆê¸° ë Œë”ë§
      renderScenarioList();
      
      console.log('=== êµì§ì› í˜„í™©íŒ V2 ì´ˆê¸°í™” ì™„ë£Œ ===');
      console.log('ì¢Œí‘œ ì‹œìŠ¤í…œ: A1 ~ T13 (20ì—´ x 13í–‰)');
      console.log('ëª…ë ¹ì–´ ì˜ˆì‹œ: "í™ê¸¸ë™ì„ í•™ìƒì²˜ë¡œ ì´ë™", "í™ê¸¸ë™ì„ C3ìœ¼ë¡œ ì´ë™"');
    });
    
    // ===== ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ =====
    function showContextMenu(x, y, card) {
      // ê¸°ì¡´ ë©”ë‰´ ì œê±°
      const existingMenu = document.querySelector('.context-menu');
      if (existingMenu) existingMenu.remove();
      
      const isEmp = card.classList.contains('emp-card');
      const isDept = card.classList.contains('dept-card');
      const cardId = card.dataset.id;
      
      // ì¹´ë“œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      let cardName = '';
      if (isEmp) {
        const nameEl = card.querySelector('.emp-name');
        cardName = nameEl ? nameEl.textContent.replace('â­', '').trim() : 'ì§ì›';
      } else if (isDept) {
        const nameEl = card.querySelector('.dept-name');
        cardName = nameEl ? nameEl.textContent : 'ë¶€ì„œ';
      }
      
      const menu = document.createElement('div');
      menu.className = 'context-menu';
      menu.innerHTML = `
        <div class="context-menu-header">${cardName}</div>
        <button class="context-menu-item" data-action="edit">
          âœï¸ í¸ì§‘
        </button>
        <button class="context-menu-item danger" data-action="delete">
          ğŸ—‘ï¸ ì‚­ì œ
        </button>
      `;
      
      // í™”ë©´ ê²½ê³„ ì²´í¬
      const menuWidth = 160;
      const menuHeight = 100;
      const adjustedX = x + menuWidth > window.innerWidth ? x - menuWidth : x;
      const adjustedY = y + menuHeight > window.innerHeight ? y - menuHeight : y;
      
      menu.style.left = adjustedX + 'px';
      menu.style.top = adjustedY + 'px';
      
      document.body.appendChild(menu);
      
      // ë©”ë‰´ í•­ëª© í´ë¦­
      menu.querySelectorAll('.context-menu-item').forEach(item => {
        item.addEventListener('click', async (e) => {
          e.stopPropagation();
          const action = item.dataset.action;
          menu.remove();
          
          if (action === 'edit') {
            if (isEmp) {
              openPhotoEditor(cardId);
            } else if (isDept) {
              // ë¶€ì„œ í¸ì§‘ì€ ë”ë¸”í´ë¦­ìœ¼ë¡œ
              card.dispatchEvent(new MouseEvent('dblclick', { bubbles: true }));
            }
          } else if (action === 'delete') {
            if (confirm(`"${cardName}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
              if (isEmp) {
                const { removeEmployee } = await import('./js/data-manager.js');
                removeEmployee(cardId);
              } else if (isDept) {
                const { removeDepartment } = await import('./js/data-manager.js');
                removeDepartment(cardId);
              }
              const { renderBoard } = await import('./js/renderer.js');
              renderBoard();
              addToHistory(`ğŸ—‘ï¸ "${cardName}" ì‚­ì œë¨`, true);
            }
          }
        });
      });
    }
    
    // ===== ì§ì› ì¶”ê°€ ëª¨ë‹¬ =====
    function openAddEmployeeModal(coord) {
      // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
      const existingModal = document.querySelector('.add-emp-modal');
      if (existingModal) existingModal.remove();
      
      const modal = document.createElement('div');
      modal.className = 'add-emp-modal';
      modal.innerHTML = `
        <div class="add-emp-content" onclick="event.stopPropagation()">
          <div class="add-emp-header">
            <h3>ğŸ‘¤ ì§ì› ì¶”ê°€ (${coord})</h3>
            <button class="btn-close-modal" type="button">âœ•</button>
          </div>
          <div class="add-emp-body">
            <label>ì´ë¦„ *</label>
            <input type="text" class="add-emp-name" placeholder="í™ê¸¸ë™" required>
            
            <label>ì§ìœ„</label>
            <input type="text" class="add-emp-position" placeholder="íŒ€ì¥, ì§ì›, êµìˆ˜ ë“±">
            
            <label>ì§ì¢…</label>
            <select class="add-emp-type">
              <option value="regular">ì •ê·œì§</option>
              <option value="contract">ê³„ì•½ì§</option>
              <option value="functional">ê¸°ëŠ¥ì§</option>
            </select>
            
            <label>ì†Œì† ë¶€ì„œ</label>
            <input type="text" class="add-emp-dept" placeholder="êµë¬´ì²˜, í•™ìƒì²˜ ë“±">
          </div>
          <div class="add-emp-footer">
            <button class="btn-cancel" type="button">ì·¨ì†Œ</button>
            <button class="btn-save" type="button">ì¶”ê°€</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      const nameInput = modal.querySelector('.add-emp-name');
      const posInput = modal.querySelector('.add-emp-position');
      const typeSelect = modal.querySelector('.add-emp-type');
      const deptInput = modal.querySelector('.add-emp-dept');
      const closeBtn = modal.querySelector('.btn-close-modal');
      const cancelBtn = modal.querySelector('.btn-cancel');
      const saveBtn = modal.querySelector('.btn-save');
      
      setTimeout(() => nameInput.focus(), 100);
      
      const closeModal = (e) => {
        if (e) e.stopPropagation();
        modal.remove();
      };
      
      closeBtn.addEventListener('click', closeModal);
      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal(e);
      });
      
      // ì €ì¥
      saveBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const name = nameInput.value.trim();
        if (!name) {
          alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
          nameInput.focus();
          return;
        }
        
        // data-manager.jsì˜ addEmployee ì‚¬ìš©
        const { addEmployee } = await import('./js/data-manager.js');
        const newEmp = addEmployee({
          name: name,
          position: posInput.value.trim(),
          empType: typeSelect.value,
          dept: deptInput.value.trim(),
          coordinate: coord
        });
        
        if (newEmp) {
          const { renderBoard, highlightCard } = await import('./js/renderer.js');
          renderBoard();
          highlightCard(coord);
          addToHistory(`âœ… "${name}" ì§ì›ì„ ${coord}ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤`, true);
        }
        
        closeModal();
      });
      
      // Enter í‚¤ë¡œ ì €ì¥
      modal.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          saveBtn.click();
        }
      });
    }
    
    // ===== ì¶”ê°€ ì„ íƒ ëª¨ë‹¬ (ì§ì›/ë¶€ì„œ) =====
    function openAddSelectionModal(coord) {
      const existingModal = document.querySelector('.add-selection-modal');
      if (existingModal) existingModal.remove();
      
      const modal = document.createElement('div');
      modal.className = 'add-selection-modal';
      modal.innerHTML = `
        <div class="add-selection-content" onclick="event.stopPropagation()">
          <div class="add-selection-header">
            <h3>â• ì¶”ê°€í•˜ê¸° (${coord})</h3>
            <button class="btn-close-modal" type="button">âœ•</button>
          </div>
          <div class="add-selection-body">
            <button class="btn-add-emp" type="button">
              <span class="icon">ğŸ‘¤</span>
              <span class="text">ì§ì› ì¶”ê°€</span>
            </button>
            <button class="btn-add-dept" type="button">
              <span class="icon">ğŸ¢</span>
              <span class="text">ë¶€ì„œ ì¶”ê°€</span>
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      const closeBtn = modal.querySelector('.btn-close-modal');
      const addEmpBtn = modal.querySelector('.btn-add-emp');
      const addDeptBtn = modal.querySelector('.btn-add-dept');
      
      const closeModal = () => modal.remove();
      
      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
      
      addEmpBtn.addEventListener('click', () => {
        closeModal();
        openAddEmployeeModal(coord);
      });
      
      addDeptBtn.addEventListener('click', () => {
        closeModal();
        openAddDeptModal(coord);
      });
    }
    
    // ===== ë¶€ì„œ ì¶”ê°€ ëª¨ë‹¬ =====
    function openAddDeptModal(coord) {
      const existingModal = document.querySelector('.add-dept-modal');
      if (existingModal) existingModal.remove();
      
      const modal = document.createElement('div');
      modal.className = 'add-dept-modal';
      modal.innerHTML = `
        <div class="add-dept-content" onclick="event.stopPropagation()">
          <div class="add-dept-header">
            <h3>ğŸ¢ ë¶€ì„œ ì¶”ê°€ (${coord})</h3>
            <button class="btn-close-modal" type="button">âœ•</button>
          </div>
          <div class="add-dept-body">
            <label>ë¶€ì„œëª… *</label>
            <input type="text" class="add-dept-name" placeholder="êµë¬´ì²˜, í•™ìƒì²˜ ë“±" required>
            
            <label>ë¶€ì œëª© (ì„ íƒ)</label>
            <input type="text" class="add-dept-sub" placeholder="êµìˆ˜í•™ìŠµê°œë°œì„¼í„° ë“±">
            
            <label>
              <input type="checkbox" class="add-dept-parent">
              ìƒìœ„ ì¡°ì§ (ë…¸ë€ ë°‘ì¤„)
            </label>
          </div>
          <div class="add-dept-footer">
            <button class="btn-cancel" type="button">ì·¨ì†Œ</button>
            <button class="btn-save" type="button">ì¶”ê°€</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      const nameInput = modal.querySelector('.add-dept-name');
      const subInput = modal.querySelector('.add-dept-sub');
      const parentCheckbox = modal.querySelector('.add-dept-parent');
      const closeBtn = modal.querySelector('.btn-close-modal');
      const cancelBtn = modal.querySelector('.btn-cancel');
      const saveBtn = modal.querySelector('.btn-save');
      
      setTimeout(() => nameInput.focus(), 100);
      
      const closeModal = (e) => {
        if (e) e.stopPropagation();
        modal.remove();
      };
      
      closeBtn.addEventListener('click', closeModal);
      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal(e);
      });
      
      // ì €ì¥
      saveBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const name = nameInput.value.trim();
        if (!name) {
          alert('ë¶€ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
          nameInput.focus();
          return;
        }
        
        const { addDepartment } = await import('./js/data-manager.js');
        const newDept = addDepartment({
          dept: name,
          subDept: subInput.value.trim(),
          isParentOrg: parentCheckbox.checked,
          coordinate: coord
        });
        
        if (newDept) {
          const { renderBoard, highlightCard } = await import('./js/renderer.js');
          renderBoard();
          highlightCard(coord);
          addToHistory(`âœ… "${name}" ë¶€ì„œë¥¼ ${coord}ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤`, true);
        }
        
        closeModal();
      });
      
      // Enter í‚¤ë¡œ ì €ì¥
      modal.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          saveBtn.click();
        }
      });
    }
  </script>
</body>
</html>
